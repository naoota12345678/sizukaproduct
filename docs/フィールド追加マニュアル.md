# フォーム項目追加マニュアル

フォームに新しい項目（例：担当者名）を追加して、ウェブアプリに表示するまでの手順。

---

## 全体の流れ

```
① フォーム項目追加 → ② GAS修正 → ③ ウェブアプリ修正 → ④ push
```

---

## ① Googleフォームに項目を追加

フォームに新しい質問を追加する。
→ 回答がスプレッドシート「フォームの回答 1」シートの新しい列に入る。

---

## ② GAS（allgs.gs + firestore_sync.gs）を修正

### 2-1. processAll内の変換処理を修正

「フォームの回答 1」→「変換」シートへの変換で、新しい列を含めるように修正。

**変換シートの現在の列構成：**
| 列 | 内容 |
|----|------|
| A (index 0) | 日付 |
| B (index 1) | 商品名 |
| C (index 2) | 包装タイプ |
| D (index 3) | 数量 |
| E (index 4) | 商品コード |

例えば「担当者」を追加する場合、F列（index 5）に入るようにprocessAllを修正。

### 2-2. firestore_sync.gs の syncProductionsToFirestore を修正

`syncProductionsToFirestore` 関数内で、新しいフィールドを読み取ってFirestoreに書き込む。

**変更箇所（firestore_sync.gs 170行目付近）：**

```javascript
// 変更前
const productName = row[1] ? row[1].toString().trim() : '';
const packageType = row[2] ? row[2].toString().trim() : '';
const quantity = Number(row[3]) || 0;
const productCode = row[4] ? row[4].toString().trim() : '';

// 変更後（担当者を追加する例）
const productName = row[1] ? row[1].toString().trim() : '';
const packageType = row[2] ? row[2].toString().trim() : '';
const quantity = Number(row[3]) || 0;
const productCode = row[4] ? row[4].toString().trim() : '';
const worker = row[5] ? row[5].toString().trim() : '';  // ← 追加
```

**集計部分も修正（180行目付近）：**

```javascript
// 変更前
aggregated[key] = {
  date: dateStr,
  productName: productName,
  packageType: packageType,
  quantity: quantity,
  productCode: productCode
};

// 変更後
aggregated[key] = {
  date: dateStr,
  productName: productName,
  packageType: packageType,
  quantity: quantity,
  productCode: productCode,
  worker: worker  // ← 追加
};
```

**Firestore書き込み部分も修正（198行目付近）：**

```javascript
// 変更前
fields: toFirestoreFields_({
  date: entry.date,
  productName: entry.productName,
  packageType: entry.packageType,
  quantity: entry.quantity,
  productCode: entry.productCode,
  createdAt: new Date()
})

// 変更後
fields: toFirestoreFields_({
  date: entry.date,
  productName: entry.productName,
  packageType: entry.packageType,
  quantity: entry.quantity,
  productCode: entry.productCode,
  worker: entry.worker,  // ← 追加
  createdAt: new Date()
})
```

---

## ③ ウェブアプリを修正

### 3-1. firebase.ts の型定義にフィールド追加

**ファイル：** `src/lib/firebase.ts`

```typescript
// 変更前
export interface Production {
  date: string;
  productName: string;
  packageType: string;
  quantity: number;
  productCode: string;
  createdAt?: unknown;
}

// 変更後
export interface Production {
  date: string;
  productName: string;
  packageType: string;
  quantity: number;
  productCode: string;
  worker?: string;  // ← 追加（?は既存データにないため）
  createdAt?: unknown;
}
```

### 3-2. テーブルに列を追加

例として `src/app/daily/page.tsx` のテーブルに「担当者」列を追加：

**theadに追加：**
```tsx
<th className="px-6 py-3 font-medium">担当者</th>
```

**tbodyに追加：**
```tsx
<td className="px-6 py-3 text-sm text-slate-600">
  {item.worker || "-"}
</td>
```

※ 必要に応じて月次・年次の画面にも同様に追加。

---

## ④ GitHubにpushしてデプロイ

```bash
cd manufacturing-app
git add .
git commit -m "担当者フィールドを追加"
git push origin main
```

Vercel連携済みなら自動でデプロイされる。

---

## 注意事項

- 新しいフィールドを追加しても、**過去のデータにはそのフィールドがない**。表示時に `item.worker || "-"` のように未定義対応が必要。
- 過去データにも反映したい場合は、`syncAllHistoricalData` のような一括再同期が必要。
- Firestoreのインデックスは、新フィールドでフィルタや並べ替えをしない限り不要。
